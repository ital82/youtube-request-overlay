<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTubeæ›²ãƒªã‚¯ã‚¨ã‚¹ãƒˆ ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Archivo+Black&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --chroma-key: #00ff00;
            --bg-dark: #1a1a2e;
            --accent-hot: #ff006e;
            --accent-cool: #00f5ff;
            --text-light: #ffffff;
            --text-dim: #a0a0b0;
            --shadow-intense: 0 8px 32px rgba(0, 0, 0, 0.8);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            background: var(--chroma-key);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆï¼šã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ«è¡¨ç¤ºæ™‚ã¯èƒŒæ™¯ã‚’ãƒ€ãƒ¼ã‚¯ */
        body.control-mode {
            background: var(--bg-dark);
        }

        /* ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ãƒ¢ãƒ¼ãƒ‰ï¼šèƒŒæ™¯ã‚’ã‚¯ãƒ­ãƒã‚­ãƒ¼ã‚°ãƒªãƒ¼ãƒ³ */
        body.overlay-mode {
            background: var(--chroma-key);
        }

        /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« */
        #control-panel {
            max-width: 800px;
            margin: 40px auto;
            padding: 30px;
            background: linear-gradient(135deg, #2a2a4e 0%, #1a1a2e 100%);
            border-radius: 16px;
            box-shadow: var(--shadow-intense);
            display: none;
        }

        body.control-mode #control-panel {
            display: block;
        }

        h1 {
            font-family: 'Archivo Black', sans-serif;
            font-size: 2.5rem;
            color: var(--accent-hot);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .subtitle {
            color: var(--text-dim);
            margin-bottom: 30px;
            font-size: 0.95rem;
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            color: var(--text-light);
            margin-bottom: 8px;
            font-weight: 700;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        input[type="text"] {
            width: 100%;
            padding: 14px 18px;
            font-size: 1rem;
            font-family: 'Noto Sans JP', sans-serif;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: var(--text-light);
            transition: all 0.3s ease;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: var(--accent-cool);
            background: rgba(255, 255, 255, 0.08);
            box-shadow: 0 0 0 4px rgba(0, 245, 255, 0.1);
        }

        input[type="text"]::placeholder {
            color: var(--text-dim);
        }

        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 24px;
            flex-wrap: wrap;
        }

        button {
            flex: 1;
            min-width: 140px;
            padding: 14px 24px;
            font-family: 'Archivo Black', sans-serif;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        button:hover::before {
            width: 300px;
            height: 300px;
        }

        button span {
            position: relative;
            z-index: 1;
        }

        .btn-start {
            background: linear-gradient(135deg, var(--accent-hot) 0%, #d90058 100%);
            color: white;
        }

        .btn-start:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(255, 0, 110, 0.4);
        }

        .btn-stop {
            background: linear-gradient(135deg, #666 0%, #444 100%);
            color: white;
        }

        .btn-stop:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
        }

        .btn-clear {
            background: linear-gradient(135deg, #ff4444 0%, #cc0000 100%);
            color: white;
        }

        .btn-clear:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(255, 68, 68, 0.4);
        }

        .btn-overlay {
            background: linear-gradient(135deg, var(--accent-cool) 0%, #00d4ff 100%);
            color: #1a1a2e;
        }

        .btn-overlay:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 245, 255, 0.4);
        }

        #status {
            margin-top: 24px;
            padding: 16px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            border-left: 4px solid var(--accent-cool);
        }

        .status-line {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--text-light);
            margin: 6px 0;
            font-size: 0.9rem;
        }

        .status-label {
            color: var(--text-dim);
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 1px;
        }

        .status-value {
            font-weight: 700;
            color: var(--accent-cool);
        }

        .status-value.active {
            color: var(--accent-hot);
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        /* ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤è¡¨ç¤ºã‚¨ãƒªã‚¢ */
        #overlay-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            padding: 40px;
        }

        body.overlay-mode #overlay-container {
            display: block;
        }

        #requests {
            list-style: none;
            max-width: 1200px;
            margin: 0 auto;
        }

        .request-item {
            background: linear-gradient(135deg, rgba(26, 26, 46, 0.95) 0%, rgba(42, 42, 78, 0.95) 100%);
            margin: 16px 0;
            padding: 20px 24px;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
            border-left: 6px solid var(--accent-hot);
            animation: slideIn 0.4s ease-out;
            transition: all 0.3s ease;
        }

        .request-item:hover {
            transform: translateX(8px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.8);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-40px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .request-content {
            flex: 1;
        }

        .song-text {
            font-family: 'Archivo Black', sans-serif;
            font-size: 1.8rem;
            color: var(--text-light);
            margin-bottom: 6px;
            letter-spacing: 0.5px;
        }

        .author-text {
            font-size: 1rem;
            color: var(--text-dim);
            font-weight: 400;
        }

        .request-actions {
            display: flex;
            gap: 10px;
        }

        .btn-done, .btn-undo-single {
            padding: 10px 20px;
            font-family: 'Archivo Black', sans-serif;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-done {
            background: linear-gradient(135deg, #00ff88 0%, #00cc66 100%);
            color: #1a1a2e;
        }

        .btn-done:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(0, 255, 136, 0.4);
        }

        .btn-undo-single {
            background: linear-gradient(135deg, #ffaa00 0%, #ff8800 100%);
            color: white;
        }

        .btn-undo-single:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(255, 170, 0, 0.4);
        }

        /* ç©ºã®çŠ¶æ…‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: var(--text-dim);
        }

        .empty-state .icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .empty-state p {
            font-size: 1.2rem;
            font-family: 'Archivo Black', sans-serif;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        /* ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ï¼ˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ãƒ¢ãƒ¼ãƒ‰æ™‚ã«è¡¨ç¤ºï¼‰ */
        #mode-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 24px;
            background: rgba(26, 26, 46, 0.9);
            border: 2px solid var(--accent-cool);
            border-radius: 8px;
            color: var(--text-light);
            font-family: 'Archivo Black', sans-serif;
            font-size: 0.8rem;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s ease;
            display: none;
            z-index: 1000;
        }

        body.overlay-mode #mode-toggle {
            display: block;
        }

        #mode-toggle:hover {
            background: var(--accent-cool);
            color: #1a1a2e;
            transform: scale(1.05);
        }

        /* ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
        .error-message {
            background: rgba(255, 68, 68, 0.2);
            border: 2px solid #ff4444;
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
            color: #ff8888;
            font-size: 0.9rem;
            display: none;
        }

        .error-message.show {
            display: block;
            animation: shake 0.5s ease;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top-color: var(--accent-cool);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-left: 10px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
        @media (max-width: 768px) {
            h1 {
                font-size: 1.8rem;
            }
            
            .song-text {
                font-size: 1.4rem;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            button {
                width: 100%;
                min-height: 48px; /* ã‚¿ãƒƒãƒæ“ä½œã«æœ€é© */
            }

            #control-panel {
                margin: 20px;
                padding: 20px;
            }

            .request-item {
                padding: 16px;
                flex-direction: column;
                align-items: flex-start;
            }

            .request-content {
                width: 100%;
                margin-bottom: 12px;
            }

            .request-actions {
                width: 100%;
                justify-content: stretch;
            }

            .btn-done, .btn-undo-single {
                flex: 1;
                min-height: 44px; /* ã‚¿ãƒƒãƒæ“ä½œã«æœ€é© */
                font-size: 0.9rem;
            }

            #overlay-container {
                padding: 20px 10px;
            }

            #mode-toggle {
                top: 10px;
                right: 10px;
                padding: 10px 20px;
                font-size: 0.75rem;
            }

            input[type="text"] {
                font-size: 16px; /* iOSã®ã‚ºãƒ¼ãƒ é˜²æ­¢ */
            }

            .author-text {
                font-size: 0.9rem;
            }

            .status-line {
                flex-direction: column;
                align-items: flex-start;
                gap: 4px;
            }
        }

        /* è¶…å°å‹ã‚¹ãƒãƒ›å¯¾å¿œ */
        @media (max-width: 480px) {
            h1 {
                font-size: 1.5rem;
            }

            .song-text {
                font-size: 1.2rem;
            }

            #control-panel {
                margin: 10px;
                padding: 16px;
            }
        }

        /* ã‚¿ãƒƒãƒãƒ‡ãƒã‚¤ã‚¹ç”¨ã®ãƒ›ãƒãƒ¼ã‚¨ãƒ•ã‚§ã‚¯ãƒˆç„¡åŠ¹åŒ– */
        @media (hover: none) {
            button:hover::before {
                width: 0;
                height: 0;
            }

            .request-item:hover {
                transform: none;
            }

            button:active {
                transform: scale(0.95);
            }
        }
    </style>
</head>
<body class="control-mode">
    <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« -->
    <div id="control-panel">
        <h1>ğŸµ Request Overlay</h1>
        <p class="subtitle">YouTubeé…ä¿¡ã®æ›²ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è‡ªå‹•æŠ½å‡ºã—ã¦ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤è¡¨ç¤º</p>

        <div class="input-group">
            <label for="videoUrl">é…ä¿¡URL</label>
            <input type="text" id="videoUrl" placeholder="https://www.youtube.com/watch?v=... ã‚’è²¼ã‚Šä»˜ã‘">
        </div>

        <div class="input-group">
            <label for="commandPrefix">ã‚³ãƒãƒ³ãƒ‰å½¢å¼ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: #reqï¼‰</label>
            <input type="text" id="commandPrefix" value="#req" placeholder="#req">
        </div>

        <div class="button-group">
            <button class="btn-start" onclick="startMonitoring()"><span>ğŸš€ ç›£è¦–é–‹å§‹</span></button>
            <button class="btn-stop" onclick="stopMonitoring()"><span>â¸ï¸ åœæ­¢</span></button>
            <button class="btn-clear" onclick="clearAll()"><span>ğŸ—‘ï¸ å…¨æ¶ˆã—</span></button>
            <button class="btn-overlay" onclick="switchToOverlay()"><span>ğŸ“º ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤è¡¨ç¤º</span></button>
        </div>

        <div id="status">
            <div class="status-line">
                <span class="status-label">ç›£è¦–çŠ¶æ…‹:</span>
                <span class="status-value" id="status-monitoring">åœæ­¢ä¸­</span>
            </div>
            <div class="status-line">
                <span class="status-label">é…ä¿¡ID:</span>
                <span class="status-value" id="status-video">æœªè¨­å®š</span>
            </div>
            <div class="status-line">
                <span class="status-label">å–å¾—ã‚³ãƒ¡ãƒ³ãƒˆæ•°:</span>
                <span class="status-value" id="status-count">0</span>
            </div>
            <div class="status-line">
                <span class="status-label">æœ€çµ‚å–å¾—:</span>
                <span class="status-value" id="status-last">â€”</span>
            </div>
        </div>

        <div class="error-message" id="error-message"></div>

        <div style="margin-top: 30px; padding: 20px; background: rgba(0, 0, 0, 0.2); border-radius: 8px; font-size: 0.85rem; color: var(--text-dim);">
            <strong style="color: var(--accent-cool);">ğŸ’¡ ä½¿ã„æ–¹</strong><br>
            1. é…ä¿¡URLã‚’è²¼ã‚Šä»˜ã‘ã¦ã€Œç›£è¦–é–‹å§‹ã€<br>
            2. ã€Œã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤è¡¨ç¤ºã€ã§ã‚¯ãƒ­ãƒã‚­ãƒ¼ç”¨ç”»é¢ã«åˆ‡ã‚Šæ›¿ãˆ<br>
            3. OBSã®ãƒ–ãƒ©ã‚¦ã‚¶ã‚½ãƒ¼ã‚¹ã§ã“ã®URLã‚’è¿½åŠ <br>
            4. ã‚¯ãƒ­ãƒã‚­ãƒ¼ãƒ•ã‚£ãƒ«ã‚¿ã§èƒŒæ™¯ï¼ˆã‚°ãƒªãƒ¼ãƒ³ï¼‰ã‚’æŠœã<br><br>
            <strong style="color: var(--accent-cool);">ğŸ“± ã‚¹ãƒãƒ›æ“ä½œã«ã¤ã„ã¦</strong><br>
            â€¢ ã‚¹ãƒãƒ›ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å‰Šé™¤æ“ä½œãŒã§ãã¾ã™<br>
            â€¢ PCã¨ã‚¹ãƒãƒ›ã§åŒã˜URLã‚’é–‹ã‘ã°è‡ªå‹•åŒæœŸ<br>
            â€¢ ã‚¹ãƒãƒ›ã§ã€Œæ¸ˆã€ã‚’ã‚¿ãƒƒãƒ— â†’ PCã®è¡¨ç¤ºã‚‚å³åº§ã«æ›´æ–°<br><br>
            <strong style="color: var(--accent-cool);">ğŸ“ è¦–è´è€…å´ã®ä½¿ã„æ–¹</strong><br>
            ã‚³ãƒ¡ãƒ³ãƒˆã§ã€Œ<strong style="color: var(--accent-hot);">#req æ›²å</strong>ã€ã¨æŠ•ç¨¿ã™ã‚‹ã¨è‡ªå‹•æŠ½å‡ºã•ã‚Œã¾ã™
        </div>
    </div>

    <!-- ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <div id="overlay-container">
        <button id="mode-toggle" onclick="switchToControl()">âš™ï¸ è¨­å®šã«æˆ»ã‚‹</button>
        <ul id="requests">
            <!-- ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒã“ã“ã«è¿½åŠ ã•ã‚Œã‚‹ -->
        </ul>
    </div>

    <script>
        // ===== ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° =====
        let monitoringInterval = null;
        let continuation = null;
        let apiKey = null;
        let clientVersion = null;
        let requestList = [];
        let deletedHistory = [];
        let totalCount = 0;
        let videoId = null;
        let syncInterval = null;

        // ===== LocalStorageåŒæœŸï¼ˆè¤‡æ•°ãƒ‡ãƒã‚¤ã‚¹å¯¾å¿œï¼‰ =====
        const STORAGE_KEY = 'youtube_request_overlay_state';
        
        function saveState() {
            try {
                const state = {
                    requestList: requestList,
                    totalCount: totalCount,
                    videoId: videoId,
                    timestamp: Date.now()
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
            } catch (e) {
                console.warn('LocalStorageä¿å­˜å¤±æ•—:', e);
            }
        }

        function loadState() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (!saved) return false;
                
                const state = JSON.parse(saved);
                
                // 5åˆ†ä»¥å†…ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿å¾©å…ƒ
                if (Date.now() - state.timestamp < 5 * 60 * 1000) {
                    requestList = state.requestList || [];
                    totalCount = state.totalCount || 0;
                    videoId = state.videoId || null;
                    
                    renderRequests();
                    updateStatus();
                    return true;
                }
            } catch (e) {
                console.warn('LocalStorageèª­ã¿è¾¼ã¿å¤±æ•—:', e);
            }
            return false;
        }

        // ä»–ã®ã‚¿ãƒ–/ãƒ‡ãƒã‚¤ã‚¹ã§ã®å¤‰æ›´ã‚’æ¤œçŸ¥
        window.addEventListener('storage', (e) => {
            if (e.key === STORAGE_KEY) {
                loadState();
            }
        });

        // å®šæœŸçš„ã«çŠ¶æ…‹ã‚’ä¿å­˜ï¼ˆ1ç§’ã”ã¨ï¼‰
        function startSync() {
            syncInterval = setInterval(() => {
                saveState();
            }, 1000);
        }

        function stopSync() {
            if (syncInterval) {
                clearInterval(syncInterval);
                syncInterval = null;
            }
        }

        // ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•° =====
        function extractVideoId(url) {
            const patterns = [
                /(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/,
                /youtube\.com\/live\/([a-zA-Z0-9_-]{11})/
            ];
            
            for (const pattern of patterns) {
                const match = url.match(pattern);
                if (match) return match[1];
            }
            return null;
        }

        function showError(message) {
            const errorEl = document.getElementById('error-message');
            errorEl.textContent = message;
            errorEl.classList.add('show');
            setTimeout(() => errorEl.classList.remove('show'), 5000);
        }

        function updateStatus() {
            document.getElementById('status-video').textContent = videoId || 'æœªè¨­å®š';
            document.getElementById('status-count').textContent = totalCount;
            document.getElementById('status-last').textContent = new Date().toLocaleTimeString('ja-JP');
        }

        // ===== YouTube InnerTube APIé–¢é€£ =====
        
        // è¤‡æ•°ã®CORSãƒ—ãƒ­ã‚­ã‚·ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ–¹å¼ï¼‰
        const CORS_PROXIES = [
            '', // ãƒ—ãƒ­ã‚­ã‚·ãªã—ã§ç›´æ¥è©¦è¡Œï¼ˆä¸€éƒ¨ã®ç’°å¢ƒã§å‹•ä½œã™ã‚‹å¯èƒ½æ€§ï¼‰
            'https://api.allorigins.win/raw?url=',
            'https://cors-anywhere.herokuapp.com/',
            'https://corsproxy.io/?'
        ];
        
        let currentProxyIndex = 0;
        
        async function fetchWithProxy(url, options = {}) {
            // ã™ã¹ã¦ã®ãƒ—ãƒ­ã‚­ã‚·ã‚’é †ç•ªã«è©¦ã™
            for (let i = 0; i < CORS_PROXIES.length; i++) {
                const proxyIndex = (currentProxyIndex + i) % CORS_PROXIES.length;
                const proxy = CORS_PROXIES[proxyIndex];
                
                try {
                    const targetUrl = proxy ? proxy + encodeURIComponent(url) : url;
                    console.log(`Proxy ${proxyIndex} ã‚’è©¦è¡Œä¸­: ${proxy || 'ãªã—'}`);
                    
                    const response = await fetch(targetUrl, options);
                    
                    if (response.ok) {
                        console.log(`Proxy ${proxyIndex} ã§æˆåŠŸ`);
                        currentProxyIndex = proxyIndex; // æˆåŠŸã—ãŸãƒ—ãƒ­ã‚­ã‚·ã‚’è¨˜æ†¶
                        return response;
                    }
                    
                    console.warn(`Proxy ${proxyIndex} ãŒ ${response.status} ã‚’è¿”ã—ã¾ã—ãŸ`);
                } catch (error) {
                    console.warn(`Proxy ${proxyIndex} ã§ã‚¨ãƒ©ãƒ¼:`, error.message);
                }
            }
            
            // ã™ã¹ã¦å¤±æ•—
            throw new Error('ã™ã¹ã¦ã®CORSãƒ—ãƒ­ã‚­ã‚·ã§å¤±æ•—ã—ã¾ã—ãŸã€‚è‡ªå‰ãƒ—ãƒ­ã‚­ã‚·ã®ä½¿ç”¨ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚');
        }
        
        async function getInitialParams(vid) {
            try {
                const targetUrl = `https://www.youtube.com/watch?v=${vid}`;
                
                const response = await fetchWithProxy(targetUrl);
                const html = await response.text();

                // ytInitialDataã‚’æŠ½å‡º
                const ytInitialDataMatch = html.match(/var ytInitialData = ({.+?});/);
                if (!ytInitialDataMatch) {
                    throw new Error('ytInitialDataãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
                
                const ytInitialData = JSON.parse(ytInitialDataMatch[1]);

                // APIã‚­ãƒ¼ã‚’æŠ½å‡º
                const apiKeyMatch = html.match(/"INNERTUBE_API_KEY":"([^"]+)"/);
                if (!apiKeyMatch) {
                    throw new Error('APIã‚­ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
                apiKey = apiKeyMatch[1];

                // clientVersionã‚’æŠ½å‡º
                const clientVersionMatch = html.match(/"clientVersion":"([^"]+)"/);
                if (clientVersionMatch) {
                    clientVersion = clientVersionMatch[1];
                }

                // continuationã‚’æŠ½å‡º
                const liveChatRenderer = ytInitialData?.contents?.twoColumnWatchNextResults?.conversationBar?.liveChatRenderer;
                
                if (!liveChatRenderer) {
                    throw new Error('ã“ã®ãƒ“ãƒ‡ã‚ªã¯ãƒ©ã‚¤ãƒ–é…ä¿¡ã§ã¯ãªã„ã‹ã€ãƒãƒ£ãƒƒãƒˆãŒç„¡åŠ¹ã§ã™');
                }

                const continuations = liveChatRenderer?.continuations;
                if (continuations && continuations.length > 0) {
                    continuation = continuations[0]?.invalidationContinuationData?.continuation ||
                                 continuations[0]?.timedContinuationData?.continuation;
                }

                if (!continuation) {
                    throw new Error('continuationãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }

                return true;
            } catch (error) {
                console.error('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                showError(`åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                return false;
            }
        }

        async function pollChat() {
            if (!continuation || !apiKey) {
                console.error('ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™');
                return;
            }

            try {
                const targetUrl = `https://www.youtube.com/youtubei/v1/live_chat/get_live_chat?key=${apiKey}`;
                
                const payload = {
                    context: {
                        client: {
                            clientName: 'WEB',
                            clientVersion: clientVersion || '2.20240101.00.00'
                        }
                    },
                    continuation: continuation
                };

                const response = await fetchWithProxy(targetUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`APIå‘¼ã³å‡ºã—å¤±æ•—: ${response.status}`);
                }

                const data = await response.json();
                
                // æ¬¡ã®continuationã‚’æ›´æ–°
                const continuationData = data?.continuationContents?.liveChatContinuation?.continuations;
                if (continuationData && continuationData.length > 0) {
                    continuation = continuationData[0]?.invalidationContinuationData?.continuation ||
                                 continuationData[0]?.timedContinuationData?.continuation;
                }

                // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æŠ½å‡º
                const actions = data?.continuationContents?.liveChatContinuation?.actions || [];
                processMessages(actions);
                
                updateStatus();

            } catch (error) {
                console.error('ãƒãƒ¼ãƒªãƒ³ã‚°ã‚¨ãƒ©ãƒ¼:', error);
                showError(`ãƒãƒ£ãƒƒãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ãƒãƒ¼ãƒªãƒ³ã‚°ã¯ç¶™ç¶šï¼ˆä¸€æ™‚çš„ãªãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã®å¯èƒ½æ€§ï¼‰
            }
        }

        function processMessages(actions) {
            const commandPrefix = document.getElementById('commandPrefix').value || '#req';
            
            actions.forEach(action => {
                const item = action?.addChatItemAction?.item;
                if (!item) return;

                const renderer = item.liveChatTextMessageRenderer || item.liveChatPaidMessageRenderer;
                if (!renderer) return;

                // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ†ã‚­ã‚¹ãƒˆã‚’çµåˆ
                const messageParts = renderer.message?.runs || [];
                const messageText = messageParts
                    .map(run => run.text || run.emoji?.shortcuts?.[0] || '')
                    .join('')
                    .trim();

                // ã‚³ãƒãƒ³ãƒ‰ãƒã‚§ãƒƒã‚¯
                if (!messageText.startsWith(commandPrefix)) return;

                // æ›²åã‚’æŠ½å‡º
                const songText = messageText
                    .substring(commandPrefix.length)
                    .trim();

                if (songText.length < 2) return; // çŸ­ã™ãã‚‹å ´åˆã¯ç„¡è¦–

                // æŠ•ç¨¿è€…åã‚’å–å¾—
                const authorName = renderer.authorName?.simpleText || 'åç„¡ã—';

                // é‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼ˆåŒã˜æŠ•ç¨¿è€…ãƒ»åŒã˜æ›²åã¯ç„¡è¦–ï¼‰
                const isDuplicate = requestList.some(
                    req => req.author === authorName && req.songText === songText
                );

                if (isDuplicate) return;

                // ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¿½åŠ 
                const request = {
                    id: `req-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                    songText: songText,
                    author: authorName,
                    messageId: renderer.id,
                    timestamp: Date.now()
                };

                requestList.push(request);
                totalCount++;
                renderRequests();
            });
        }

        // ===== UIåˆ¶å¾¡ =====
        function renderRequests() {
            const container = document.getElementById('requests');
            
            // è¡¨ç¤ºä»¶æ•°åˆ¶é™ï¼ˆæœ€å¤§20ä»¶ï¼‰
            const displayList = requestList.slice(-20);
            
            if (displayList.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">ğŸµ</div>
                        <p>ãƒªã‚¯ã‚¨ã‚¹ãƒˆå¾…æ©Ÿä¸­...</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = displayList.map(req => `
                <li class="request-item" data-id="${req.id}">
                    <div class="request-content">
                        <div class="song-text">${escapeHtml(req.songText)}</div>
                        <div class="author-text">ãƒªã‚¯ã‚¨ã‚¹ãƒˆ: ${escapeHtml(req.author)}</div>
                    </div>
                    <div class="request-actions">
                        <button class="btn-done" onclick="removeRequest('${req.id}')">âœ“ æ¸ˆ</button>
                    </div>
                </li>
            `).join('');
            
            // çŠ¶æ…‹ã‚’ä¿å­˜
            saveState();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function removeRequest(requestId) {
            const index = requestList.findIndex(req => req.id === requestId);
            if (index !== -1) {
                const removed = requestList.splice(index, 1)[0];
                deletedHistory.push(removed);
                renderRequests();
            }
        }

        function undoLastDelete() {
            if (deletedHistory.length > 0) {
                const restored = deletedHistory.pop();
                requestList.push(restored);
                renderRequests();
            }
        }

        function clearAll() {
            if (requestList.length === 0) return;
            
            if (confirm('ã™ã¹ã¦ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                deletedHistory = [...requestList];
                requestList = [];
                renderRequests();
            }
        }

        // ===== ç›£è¦–åˆ¶å¾¡ =====
        async function startMonitoring() {
            const urlInput = document.getElementById('videoUrl').value.trim();
            
            if (!urlInput) {
                showError('é…ä¿¡URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            videoId = extractVideoId(urlInput);
            
            if (!videoId) {
                showError('æœ‰åŠ¹ãªYouTube URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            // æ—¢ã«ç›£è¦–ä¸­ãªã‚‰åœæ­¢
            if (monitoringInterval) {
                stopMonitoring();
            }

            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
            const statusEl = document.getElementById('status-monitoring');
            statusEl.innerHTML = 'åˆæœŸåŒ–ä¸­<span class="loading"></span>';
            statusEl.classList.add('active');

            // åˆæœŸãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å–å¾—
            const success = await getInitialParams(videoId);
            
            if (!success) {
                statusEl.textContent = 'åˆæœŸåŒ–å¤±æ•—';
                statusEl.classList.remove('active');
                return;
            }

            // ãƒãƒ¼ãƒªãƒ³ã‚°é–‹å§‹
            statusEl.textContent = 'ç›£è¦–ä¸­ ğŸ”´';
            monitoringInterval = setInterval(pollChat, 1500); // 1.5ç§’ã”ã¨
            
            // åŒæœŸé–‹å§‹
            startSync();
            
            // åˆå›å³åº§ã«å®Ÿè¡Œ
            pollChat();
        }

        function stopMonitoring() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
                monitoringInterval = null;
            }
            
            // åŒæœŸåœæ­¢
            stopSync();
            
            const statusEl = document.getElementById('status-monitoring');
            statusEl.textContent = 'åœæ­¢ä¸­';
            statusEl.classList.remove('active');
        }

        // ===== ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ =====
        function switchToOverlay() {
            document.body.classList.remove('control-mode');
            document.body.classList.add('overlay-mode');
            renderRequests();
        }

        function switchToControl() {
            document.body.classList.remove('overlay-mode');
            document.body.classList.add('control-mode');
        }

        // ===== ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ =====
        document.addEventListener('keydown', (e) => {
            // Ctrl+Z: Undo
            if (e.ctrlKey && e.key === 'z') {
                e.preventDefault();
                undoLastDelete();
            }
            
            // Escape: ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ¢ãƒ¼ãƒ‰ã«æˆ»ã‚‹
            if (e.key === 'Escape') {
                switchToControl();
            }
        });

        // ===== åˆæœŸåŒ– =====
        console.log('YouTube Request Overlay èµ·å‹•');
        
        // ä¿å­˜ã•ã‚ŒãŸçŠ¶æ…‹ã‚’å¾©å…ƒ
        const stateRestored = loadState();
        if (stateRestored) {
            console.log('å‰å›ã®çŠ¶æ…‹ã‚’å¾©å…ƒã—ã¾ã—ãŸ');
        }
        
        renderRequests();
    </script>
</body>
</html>
